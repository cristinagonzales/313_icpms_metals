---
title: "ICPMS Data Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = FALSE}
library(tidyverse)
library(readr)
```

```{r}
#importing the tidied ICPMS data
ICPMS <- read.csv("~/chem313/313_icpms/data/tidy_ICPMS.csv")

```

```{r}
#defining lists to be used in for loops
sample_sites <- unique(filter(ICPMS, site != "MB", site != "")$site)
#excluding method blank and quality control from list of sites
metals_analyzed <- unique(ICPMS$metal)

#preview lists to check for issues
sample_sites
metals_analyzed
```

```{r Calibration}
ICPMS_cal <- NULL
for (unique_metal in metals_analyzed) {
  #filtering for a single metal then selecting variables of interest
  cal <- ICPMS %>%
    filter(type == "Cal1" | type == "Cal2" | type == "Cal3") %>%
    filter(metal == unique_metal) %>%
    select(concentration, cps, rsd)
  #weighted linear regression
  w <- 1/(cal$cps*cal$rsd)^2
  model <- lm(cal$cps ~ cal$concentration, weights = w)
  #pulling out relevant info from model
  slope <- model$coefficients[2]
  intercept <- model$coefficients[1]
  slope_std <- summary(model)$coefficients[2,2]
  intercept_std <- summary(model)$coefficients[1,2]
  #plotting cal curve
  plot(cal$cps ~ cal$concentration,
       xlab = paste("Concentration of ", unique_metal, "(ppb)"),
       ylab = "Counts per Second") +
    abline(model, col = "red") +
    title(paste("Calibration for ", unique_metal))
  #storing info from calibration curve
  equation <- tibble(metal = unique_metal, slope, slope_std, intercept, intercept_std)
  ICPMS_cal <- rbind(ICPMS_cal, equation)
}

ICPMS_cal
```










